# å®šä¹‰å·¥ä½œæµåç§° - å½“è§¦å‘æ—¶ä¼šæ˜¾ç¤ºåœ¨GitHub Actionsç•Œé¢ä¸­
name: OpenWrt-Firmware-Build

# å®šä¹‰è§¦å‘æ¡ä»¶ - ä½¿ç”¨ workflow_dispatch è§¦å‘æ–¹å¼
on:
  workflow_dispatch:

# å®šä¹‰å·¥ä½œæµçš„æƒé™è®¾ç½® - ç»™äºˆè¯»å†™æƒé™ä»¥è¿›è¡Œæ„å»º
permissions:
  contents: read

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡é›†åˆ - ç§°ä¸º jobs
jobs:
  # å®šä¹‰ä¸€ä¸ªåä¸º build çš„ä»»åŠ¡
  build:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒ - ä½¿ç”¨ Ubuntu æœ€æ–°ç‰ˆæœ¬
    runs-on: ubuntu-latest
    
    # å®šä¹‰è¯¥ä»»åŠ¡éœ€è¦æ‰§è¡Œçš„æ­¥éª¤é›†åˆ
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç  - å°†ä»“åº“ä»£ç ä¸‹è½½åˆ°å·¥ä½œç¯å¢ƒä¸­
      - name: Checkout Source Code
        uses: actions/checkout@v4
        
      # æ­¥éª¤2ï¼šå®‰è£…ç¼–è¯‘æ‰€éœ€ä¾èµ–åŒ… - ä¸ºåç»­ç¼–è¯‘å‡†å¤‡ç¯å¢ƒ
      - name: Install Build Dependencies
        run: |
          echo "Installing build dependencies..."
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libncurses5-dev \
            zlib1g-dev \
            gawk \
            git \
            ccache \
            gettext \
            libssl-dev \
            libelf-dev \
            flex \
            bison \
            bc \
            wget \
            unzip \
            python3 \
            libpython3-dev \
            libarchive-tools
          
      # æ­¥éª¤3ï¼šæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶ - è§£å†³å‰ç½®æ£€æŸ¥å¤±è´¥é—®é¢˜
      - name: Clean Previous Build Files
        run: |
          echo "Cleaning previous build files..."
          rm -rf openwrt-source
          rm -rf ~/.ccache
          sudo apt-get clean
          
      # æ­¥éª¤4ï¼šå…‹éš†OpenWrtæºç ä»“åº“ - è·å–æŒ‡å®šåˆ†æ”¯çš„æºä»£ç 
      - name: Clone OpenWrt Source
        run: |
          echo "Cloning OpenWrt source code..."
          git clone --branch k6.12-nss https://github.com/laipeng668/openwrt-6.x.git openwrt-source
          cd openwrt-source
          git submodule update --init --recursive
          echo "Clone completed. Directory contents:"
          ls -la
          
      # æ­¥éª¤5ï¼šå¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½® - å°†æˆ‘ä»¬æä¾›çš„é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°OpenWrtæºç ç›®å½•
      - name: Copy Configuration File
        run: |
          echo "Copying configuration file..."
          mkdir -p openwrt-source/.config
          cp configs/Arthur_Athena_Full.config openwrt-source/.config/config
          echo "Configuration file content:"
          cat openwrt-source/.config/config
          
      # æ­¥éª¤6ï¼šåˆå§‹åŒ–OpenWrté…ç½®
      - name: Initialize OpenWrt Configuration
        run: |
          echo "Initializing OpenWrt configuration..."
          cd openwrt-source
          # æ¸…ç†ä¹‹å‰çš„é…ç½®å’Œæ„å»ºæ–‡ä»¶
          rm -rf staging_dir build_dir tmp .config
          mkdir -p .config
          # æ‰§è¡ŒOpenWrtçš„é…ç½®è„šæœ¬
          make defconfig
          
      # æ­¥éª¤7ï¼šæ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
      - name: Update Package List
        run: |
          echo "Updating package list..."
          cd openwrt-source
          make dirclean
          make package/download V=s
          
      # æ­¥éª¤8ï¼šå¼€å§‹ç¼–è¯‘OpenWrtå›ºä»¶ - æ ¸å¿ƒç¼–è¯‘æ­¥éª¤
      - name: Compile OpenWrt Firmware
        run: |
          echo "Starting firmware compilation..."
          cd openwrt-source
          
          # é¢„æ£€æŸ¥ç¼–è¯‘ç¯å¢ƒ
          if [ ! -f ".config/config" ]; then
            echo "âŒ Configuration file not found!"
            exit 1
          fi
          
          # å°è¯•ç¼–è¯‘ï¼Œå¸¦åˆç†çš„é”™è¯¯å¤„ç†
          echo "Compiling with parallel jobs..."
          make -j$(nproc) V=s || {
            echo "âš ï¸ First compilation attempt failed, trying recovery..."
            # æ¸…ç†å¹¶é‡æ–°é…ç½®
            rm -rf staging_dir build_dir tmp
            make clean
            make defconfig
            echo "Retrying compilation..."
            make -j$(nproc) V=s
          }
          
      # æ­¥éª¤9ï¼šæ£€æŸ¥ç¼–è¯‘ç»“æœ - éªŒè¯æ˜¯å¦æˆåŠŸç”Ÿæˆå›ºä»¶
      - name: Verify Compilation Result
        run: |
          echo "Checking compilation results..."
          cd openwrt-source
          echo "Generated firmware files:"
          find bin/targets -name "*.img" -o -name "*.bin" -o -name "*.tar.gz" | head -10
          
      # æ­¥éª¤10ï¼šä¸Šä¼ ç¼–è¯‘äº§ç‰© - å°†ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ä¸Šä¼ åˆ°GitHub
      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-Firmware-${{ github.run_number }}
          path: |
            openwrt-source/bin/targets/**
          retention-days: 7
          
      # æ­¥éª¤11ï¼šæ˜¾ç¤ºç¼–è¯‘å®Œæˆä¿¡æ¯
      - name: Compilation Complete
        run: |
          echo "âœ… OpenWrt Firmware Build Completed Successfully!"
          echo "ğŸ”§ Firmware files are available in the Artifacts section"
          echo "ğŸ“¦ Run number: ${{ github.run_number }}"
