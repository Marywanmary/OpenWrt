# å®šä¹‰å·¥ä½œæµåç§° - å½“è§¦å‘æ—¶ä¼šæ˜¾ç¤ºåœ¨GitHub Actionsç•Œé¢ä¸­
name: 0T0

# å®šä¹‰è§¦å‘æ¡ä»¶ - ä½¿ç”¨ workflow_dispatch è§¦å‘æ–¹å¼
on:
  workflow_dispatch:

# å®šä¹‰å·¥ä½œæµçš„æƒé™è®¾ç½® - ç»™äºˆè¯»å†™æƒé™ä»¥è¿›è¡Œæ„å»º
permissions:
  contents: read

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡é›†åˆ - ç§°ä¸º jobs
jobs:
  # å®šä¹‰ä¸€ä¸ªåä¸º build çš„ä»»åŠ¡
  build:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒ - ä½¿ç”¨ Ubuntu æœ€æ–°ç‰ˆæœ¬
    runs-on: ubuntu-latest
    
    # å®šä¹‰è¯¥ä»»åŠ¡éœ€è¦æ‰§è¡Œçš„æ­¥éª¤é›†åˆ
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç  - å°†ä»“åº“ä»£ç ä¸‹è½½åˆ°å·¥ä½œç¯å¢ƒä¸­
      - name: æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        
      # æ­¥éª¤2ï¼šè®¾ç½®å·¥ä½œç›®å½• - å°†å½“å‰å·¥ä½œç›®å½•åˆ‡æ¢åˆ°ä»“åº“æ ¹ç›®å½•
      - name: è®¾ç½®å·¥ä½œç›®å½•
        run: |
          cd ${{ github.workspace }}
          
      # æ­¥éª¤3ï¼šå®‰è£…ç¼–è¯‘æ‰€éœ€ä¾èµ–åŒ… - ä¸ºåç»­ç¼–è¯‘å‡†å¤‡ç¯å¢ƒ
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          # æ›´æ–°ç³»ç»ŸåŒ…ç®¡ç†å™¨ç´¢å¼•
          sudo apt-get update
          # å®‰è£…ç¼–è¯‘OpenWrtæ‰€éœ€çš„è½¯ä»¶åŒ…
          sudo apt-get install -y build-essential libncurses5-dev zlib1g-dev gawk git ccache gettext libssl-dev libelf-dev flex bison bc wget unzip
      
      # æ­¥éª¤4ï¼šå…‹éš†OpenWrtæºç ä»“åº“ - è·å–æŒ‡å®šåˆ†æ”¯çš„æºä»£ç 
      - name: å…‹éš†OpenWrtæºç 
        run: |
          # å…‹éš†æŒ‡å®šçš„OpenWrtä»“åº“ï¼Œåˆ†æ”¯ä¸º6.12-nss
          git clone --branch 6.12-nss https://github.com/laipeng668/openwrt-6.x.git openwrt-source
          
      # æ­¥éª¤5ï¼šå¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½® - å°†æˆ‘ä»¬æä¾›çš„é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°OpenWrtæºç ç›®å½•
      - name: å¤åˆ¶é…ç½®æ–‡ä»¶
        run: |
          # åˆ›å»ºOpenWrtæºç ç›®å½•ä¸‹çš„configç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p openwrt-source/.config
          # å°†æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ä»ä»“åº“æ ¹ç›®å½•å¤åˆ¶åˆ°OpenWrtæºç ç›®å½•
          cp configs/Arthur_Athena_Full.config openwrt-source/.config/config
  
      # æ­¥éª¤6ï¼šè¿›å…¥OpenWrtæºç ç›®å½•å¹¶åˆå§‹åŒ–é…ç½®
      - name: åˆå§‹åŒ–OpenWrté…ç½®
        run: |
          # è¿›å…¥OpenWrtæºç ç›®å½•
          cd openwrt-source
          # æ‰§è¡ŒOpenWrtçš„é…ç½®è„šæœ¬ï¼Œå°†é…ç½®æ–‡ä»¶åº”ç”¨åˆ°æºç ä¸­
          make defconfig
          
      # æ­¥éª¤7ï¼šä¸‹è½½å¹¶æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ - è·å–æ‰€æœ‰éœ€è¦çš„è½¯ä»¶åŒ…
      - name: æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
        run: |
          # è¿›å…¥OpenWrtæºç ç›®å½•
          cd openwrt-source
          # æ‰§è¡Œå‘½ä»¤æ¥æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ï¼Œç¡®ä¿è·å–æœ€æ–°ç‰ˆæœ¬
          make package/compile V=s
          
      # æ­¥éª¤8ï¼šå¼€å§‹ç¼–è¯‘OpenWrtå›ºä»¶ - æ ¸å¿ƒç¼–è¯‘æ­¥éª¤
      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        run: |
          # è¿›å…¥OpenWrtæºç ç›®å½•
          cd openwrt-source
          # æ‰§è¡Œç¼–è¯‘å‘½ä»¤ï¼Œä½¿ç”¨å¤šçº¿ç¨‹åŠ é€Ÿç¼–è¯‘è¿‡ç¨‹ï¼ˆ-j$(nproc)è¡¨ç¤ºä½¿ç”¨CPUæ ¸å¿ƒæ•°ï¼‰
          # V=så‚æ•°ç”¨äºæ˜¾ç¤ºè¯¦ç»†ç¼–è¯‘ä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•
          make -j$(nproc) V=s
          
      # æ­¥éª¤9ï¼šæ£€æŸ¥ç¼–è¯‘ç»“æœ - éªŒè¯æ˜¯å¦æˆåŠŸç”Ÿæˆå›ºä»¶
      - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
        run: |
          # è¿›å…¥OpenWrtæºç ç›®å½•
          cd openwrt-source
          # æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ï¼Œé€šå¸¸ä½äºbin/targetsç›®å½•ä¸‹
          echo "ç¼–è¯‘å®Œæˆçš„å›ºä»¶æ–‡ä»¶:"
          ls -la bin/targets/*
          
      # æ­¥éª¤10ï¼šä¸Šä¼ ç¼–è¯‘äº§ç‰© - å°†ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ä¸Šä¼ åˆ°GitHub
      - name: ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          # è®¾ç½®ä¸Šä¼ çš„æ–‡ä»¶åå‰ç¼€
          name: OpenWrt-Firmware
          # æŒ‡å®šè¦ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„æ¨¡å¼
          path: |
            openwrt-source/bin/targets/*
            
      # æ­¥éª¤11ï¼šæ˜¾ç¤ºç¼–è¯‘å®Œæˆä¿¡æ¯
      - name: ç¼–è¯‘å®Œæˆæç¤º
        run: |
          echo "âœ… OpenWrt ç¼–è¯‘å·²å®Œæˆï¼"
          echo "ğŸ”§ å›ºä»¶æ–‡ä»¶å·²ä¿å­˜åœ¨ openwrt-source/bin/targets/ ç›®å½•ä¸‹"
          echo "ğŸ“¦ å¯ä»¥åœ¨ GitHub Actions çš„ Artifacts ä¸­ä¸‹è½½å›ºä»¶æ–‡ä»¶"
