# å®šä¹‰å·¥ä½œæµåç§° - å½“è§¦å‘æ—¶ä¼šæ˜¾ç¤ºåœ¨GitHub Actionsç•Œé¢ä¸­
name: 0T0

# å®šä¹‰è§¦å‘æ¡ä»¶ - ä½¿ç”¨ workflow_dispatch è§¦å‘æ–¹å¼
on:
  workflow_dispatch:

# å®šä¹‰å·¥ä½œæµçš„æƒé™è®¾ç½® - ç»™äºˆè¯»å†™æƒé™ä»¥è¿›è¡Œæ„å»º
permissions:
  contents: read

# å®šä¹‰å·¥ä½œæµä¸­çš„ä»»åŠ¡é›†åˆ - ç§°ä¸º jobs
jobs:
  # å®šä¹‰ä¸€ä¸ªåä¸º build çš„ä»»åŠ¡
  build:
    # æŒ‡å®šè¿è¡Œç¯å¢ƒ - ä½¿ç”¨ Ubuntu æœ€æ–°ç‰ˆæœ¬
    runs-on: ubuntu-latest
    
    # å®šä¹‰è¯¥ä»»åŠ¡éœ€è¦æ‰§è¡Œçš„æ­¥éª¤é›†åˆ
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç  - å°†ä»“åº“ä»£ç ä¸‹è½½åˆ°å·¥ä½œç¯å¢ƒä¸­
      - name: æ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        
      # æ­¥éª¤2ï¼šè®¾ç½®å·¥ä½œç›®å½• - å°†å½“å‰å·¥ä½œç›®å½•åˆ‡æ¢åˆ°ä»“åº“æ ¹ç›®å½•
      - name: è®¾ç½®å·¥ä½œç›®å½•
        run: |
          cd ${{ github.workspace }}
          
      # æ­¥éª¤3ï¼šå®‰è£…ç¼–è¯‘æ‰€éœ€ä¾èµ–åŒ… - ä¸ºåç»­ç¼–è¯‘å‡†å¤‡ç¯å¢ƒ
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          # æ›´æ–°ç³»ç»ŸåŒ…ç®¡ç†å™¨ç´¢å¼•
          sudo apt-get update
          # å®‰è£…ç¼–è¯‘OpenWrtæ‰€éœ€çš„è½¯ä»¶åŒ…
          sudo apt-get install -y build-essential libncurses5-dev zlib1g-dev gawk git ccache gettext libssl-dev libelf-dev flex bison bc wget unzip python3 libpython3-dev libarchive-tools
      
      # æ­¥éª¤4ï¼šæ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶ - è§£å†³å‰ç½®æ£€æŸ¥å¤±è´¥é—®é¢˜
      - name: æ¸…ç†æ—§ç¼–è¯‘æ–‡ä»¶
        run: |
          # åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç¼–è¯‘ç›®å½•
          rm -rf openwrt-source
          # æ¸…ç†å¯èƒ½çš„ç¼“å­˜æ–‡ä»¶
          rm -rf ~/.ccache
          # æ¸…ç†ç³»ç»Ÿç¼“å­˜
          sudo apt-get clean
          
      # æ­¥éª¤5ï¼šå…‹éš†OpenWrtæºç ä»“åº“ - è·å–æŒ‡å®šåˆ†æ”¯çš„æºä»£ç 
      - name: å…‹éš†OpenWrtæºç 
        run: |
          # å…‹éš†æŒ‡å®šçš„OpenWrtä»“åº“ï¼Œåˆ†æ”¯ä¸ºk6.12-nss
          git clone --branch k6.12-nss https://github.com/laipeng668/openwrt-6.x.git openwrt-source
          # è¿›å…¥æºç ç›®å½•
          cd openwrt-source
          # ç¡®ä¿æ‰€æœ‰å­æ¨¡å—éƒ½å·²åˆå§‹åŒ–
          git submodule update --init --recursive
          # æ£€æŸ¥æ˜¯å¦æˆåŠŸå…‹éš†
          echo "å…‹éš†å®Œæˆï¼Œå½“å‰ç›®å½•å†…å®¹:"
          ls -la
          
      # æ­¥éª¤6ï¼šå¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½® - å°†æˆ‘ä»¬æä¾›çš„é…ç½®æ–‡ä»¶å¤åˆ¶åˆ°OpenWrtæºç ç›®å½•
      - name: å¤åˆ¶é…ç½®æ–‡ä»¶
        run: |
          # åˆ›å»ºOpenWrtæºç ç›®å½•ä¸‹çš„configç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p openwrt-source/.config
          # å°†æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ä»ä»“åº“æ ¹ç›®å½•å¤åˆ¶åˆ°OpenWrtæºç ç›®å½•
          cp configs/Arthur_Athena_Full.config openwrt-source/.config/config
          # æ˜¾ç¤ºé…ç½®æ–‡ä»¶å†…å®¹
          echo "é…ç½®æ–‡ä»¶å†…å®¹:"
          cat openwrt-source/.config/config
          
      # æ­¥éª¤7ï¼šè¿›å…¥OpenWrtæºç ç›®å½•å¹¶åˆå§‹åŒ–é…ç½®
      - name: åˆå§‹åŒ–OpenWrté…ç½®
        run: |
          # è¿›å…¥OpenWrtæºç ç›®å½•
          cd openwrt-source
          # æ¸…ç†ä¹‹å‰çš„é…ç½®å’Œæ„å»ºæ–‡ä»¶
          echo "å¼€å§‹æ¸…ç†..."
          # å¼ºåˆ¶åˆ é™¤æ‰€æœ‰ç›¸å…³ç›®å½•
          rm -rf staging_dir
          rm -rf build_dir
          rm -rf tmp
          rm -rf .config
          # é‡æ–°åˆ›å»º.configç›®å½•
          mkdir -p .config
          # æ‰§è¡ŒOpenWrtçš„é…ç½®è„šæœ¬ï¼Œå°†é…ç½®æ–‡ä»¶åº”ç”¨åˆ°æºç ä¸­
          echo "å¼€å§‹é…ç½®..."
          make defconfig
          
      # æ­¥éª¤8ï¼šä¸‹è½½å¹¶æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ - è·å–æ‰€æœ‰éœ€è¦çš„è½¯ä»¶åŒ…
      - name: æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
        run: |
          # è¿›å…¥OpenWrtæºç ç›®å½•
          cd openwrt-source
          # æ¸…ç†ä¹‹å‰å¯èƒ½å­˜åœ¨çš„ç¼“å­˜
          echo "æ¸…ç†ç¼“å­˜..."
          make dirclean
          # æ‰§è¡Œå‘½ä»¤æ¥æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ï¼Œç¡®ä¿è·å–æœ€æ–°ç‰ˆæœ¬
          echo "æ›´æ–°è½¯ä»¶åŒ…..."
          make package/download V=s
          
      # æ­¥éª¤9ï¼šå¼€å§‹ç¼–è¯‘OpenWrtå›ºä»¶ - æ ¸å¿ƒç¼–è¯‘æ­¥éª¤
      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        run: |
          # è¿›å…¥OpenWrtæºç ç›®å½•
          cd openwrt-source
          # æ˜¾ç¤ºå½“å‰ç›®å½•ä¿¡æ¯
          echo "å½“å‰ç›®å½•ä¿¡æ¯:"
          pwd
          ls -la
          # ä½¿ç”¨FORCE=1å¼ºåˆ¶ç¼–è¯‘ï¼Œè§£å†³å‰ç½®æ£€æŸ¥é—®é¢˜
          echo "å¼€å§‹ç¼–è¯‘..."
          # å…ˆå°è¯•ç®€å•çš„ç¼–è¯‘å‘½ä»¤
          make -j1 V=s FORCE=1 || \
          # å¦‚æœå¤±è´¥ï¼Œå†å°è¯•æ›´å½»åº•çš„æ¸…ç†å’Œç¼–è¯‘
          (echo "ç¬¬ä¸€æ¬¡ç¼–è¯‘å¤±è´¥ï¼Œè¿›è¡Œå½»åº•æ¸…ç†..." && \
          rm -rf staging_dir build_dir tmp && \
          make clean && \
          make defconfig && \
          make -j1 V=s FORCE=1)
          
      # æ­¥éª¤10ï¼šæ£€æŸ¥ç¼–è¯‘ç»“æœ - éªŒè¯æ˜¯å¦æˆåŠŸç”Ÿæˆå›ºä»¶
      - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
        run: |
          # è¿›å…¥OpenWrtæºç ç›®å½•
          cd openwrt-source
          # æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ï¼Œé€šå¸¸ä½äºbin/targetsç›®å½•ä¸‹
          echo "ç¼–è¯‘å®Œæˆçš„å›ºä»¶æ–‡ä»¶:"
          ls -la bin/targets/*
          
      # æ­¥éª¤11ï¼šä¸Šä¼ ç¼–è¯‘äº§ç‰© - å°†ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶ä¸Šä¼ åˆ°GitHub
      - name: ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          # è®¾ç½®ä¸Šä¼ çš„æ–‡ä»¶åå‰ç¼€
          name: OpenWrt-Firmware
          # æŒ‡å®šè¦ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„æ¨¡å¼
          path: |
            openwrt-source/bin/targets/*
            
      # æ­¥éª¤12ï¼šæ˜¾ç¤ºç¼–è¯‘å®Œæˆä¿¡æ¯
      - name: ç¼–è¯‘å®Œæˆæç¤º
        run: |
          echo "âœ… OpenWrt ç¼–è¯‘å·²å®Œæˆï¼"
          echo "ğŸ”§ å›ºä»¶æ–‡ä»¶å·²ä¿å­˜åœ¨ openwrt-source/bin/targets/ ç›®å½•ä¸‹"
          echo "ğŸ“¦ å¯ä»¥åœ¨ GitHub Actions çš„ Artifacts ä¸­ä¸‹è½½å›ºä»¶æ–‡ä»¶"
