# æ–‡ä»¶å: .github/workflows/build.yml

name: Compile OpenWrt Firmware for IPQ60XX (ARM64)

on:
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æ¯å‘¨äºˆæƒåŠ›åŒ—äº¬æ—¶é—´0ç‚¹ï¼ˆUTCå‘¨ä¸€16ç‚¹ï¼‰è§¦å‘
  schedule:
    - cron: '0 16 * * 5'

jobs:
  build_all_configs:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # ä»…ä¿ç•™ LibWrt ä»“åº“ï¼Œå‡å°‘é”™è¯¯æ¥æº
        # å®šä¹‰æ‰€æœ‰è®¾å¤‡å’Œé…ç½®çš„ç»„åˆ
        # æ³¨æ„: GitHub Actions çš„ matrix å¿…é¡»æ˜¯å¯¹è±¡æ•°ç»„
        repo: [{ value: LibWrt }] # åªä¿ç•™ LibWrt
        device: [{ value: Aruthur }, { value: Athena }]
        config: [{ value: Lite }, { value: Full }]

    steps:
      # --- 1. è·å–æºç ä»“åº“ä¿¡æ¯ ---
      - name: Get Repo Info
        id: get_repo_info
        run: |
          # æ ¹æ® repo.value ç¡®å®šä»“åº“ URL å’Œåˆ†æ”¯
          if [ '${{ matrix.repo.value }}' = 'LibWrt' ]; then
            echo "REPO_OWNER=laipeng668" >> $GITHUB_ENV
            echo "REPO_NAME=openwrt-6.x" >> $GITHUB_ENV
            echo "REPO_BRANCH=k6.12-nss" >> $GITHUB_ENV
          fi
          echo "REPO_SHORT_NAME=${{ matrix.repo.value }}" >> $GITHUB_ENV
          echo "DEVICE_SHORT_NAME=${{ matrix.device.value }}" >> $GITHUB_ENV
          echo "CONFIG_NAME=${{ matrix.config.value }}" >> $GITHUB_ENV
          echo "BUILD_TIME=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=${{ env.BUILD_TIME }}_${{ env.REPO_SHORT_NAME }}_${{ env.DEVICE_SHORT_NAME }}_${{ env.CONFIG_NAME }}" >> $GITHUB_ENV
          echo "RELEASE_TITLE=${{ env.BUILD_TIME }}_${{ env.REPO_SHORT_NAME }}_${{ env.DEVICE_SHORT_NAME }}_${{ env.CONFIG_NAME }}" >> $GITHUB_ENV
          # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´ (UTC+8)
          echo "TZ=Asia/Shanghai" >> $GITHUB_ENV

      # --- 2. å…‹éš†æºç  ---
      # ä¿®æ­£: ä½¿ç”¨ {owner}/{repo} æ ¼å¼ï¼Œè€Œä¸æ˜¯å®Œæ•´ URL
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}
          ref: ${{ env.REPO_BRANCH }}
          path: openwrt-source

      # --- 3. è·å–ç‰ˆæœ¬ä¿¡æ¯ ---
      # è·å–å†…æ ¸ç‰ˆæœ¬å’Œç‰ˆæœ¬ä¿¡æ¯
      - name: Get Version Information (è·å–ç‰ˆæœ¬ä¿¡æ¯)
        run: |
          cd openwrt-source
          echo "æ­£åœ¨è·å–ç‰ˆæœ¬ä¿¡æ¯..."

          # æ–¹æ³• 1: å°è¯•ä» kernel-version.mk è·å–å†…æ ¸ç‰ˆæœ¬ (å¸¸è§äº OpenWrt)
          if [ -f "include/kernel-version.mk" ]; then
            KERNEL_VERSION_LINE=$(grep -E "^LINUX_VERSION" "include/kernel-version.mk" | head -1)
            if [ -n "$KERNEL_VERSION_LINE" ]; then
              KERNEL_VERSION=$(echo "$KERNEL_VERSION_LINE" | sed -E 's/.*=([0-9.]+).*/\1/')
              echo "VERSION_KERNEL=$KERNEL_VERSION" >> $GITHUB_ENV
            fi
          fi

          # æ–¹æ³• 2: å¦‚æœä¸Šé¢æ²¡æ‰¾åˆ°ï¼Œå°è¯•ä» target/linux/ipq60xx/Makefile è·å– (é’ˆå¯¹ IPQ60XX)
          if [ -z "${{ env.VERSION_KERNEL }}" ] && [ -f "target/linux/ipq60xx/Makefile" ]; then
            KERNEL_VERSION_LINE=$(grep -E "LINUX_VERSION" "target/linux/ipq60xx/Makefile" | head -1)
            if [ -n "$KERNEL_VERSION_LINE" ]; then
              KERNEL_VERSION=$(echo "$KERNEL_VERSION_LINE" | sed -E 's/.*=([0-9.]+).*/\1/')
              echo "VERSION_KERNEL=$KERNEL_VERSION" >> $GITHUB_ENV
            fi
          fi

          # æ–¹æ³• 3: å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°è¯•ä» .config è·å– (æŸäº›æƒ…å†µä¸‹)
          if [ -z "${{ env.VERSION_KERNEL }}" ] && [ -f ".config" ]; then
            KERNEL_VERSION_LINE=$(grep -E "^CONFIG_LINUX_KERNEL_VERSION" ".config" | head -1)
            if [ -n "$KERNEL_VERSION_LINE" ]; then
              KERNEL_VERSION=$(echo "$KERNEL_VERSION_LINE" | sed -E 's/.*=(.*)/\1/')
              echo "VERSION_KERNEL=$KERNEL_VERSION" >> $GITHUB_ENV
            fi
          fi

          # å¦‚æœä»æœªæ‰¾åˆ°ï¼Œè®¾ç½®é»˜è®¤å€¼
          if [ -z "${{ env.VERSION_KERNEL }}" ]; then
            echo "VERSION_KERNEL=Unknown" >> $GITHUB_ENV
          fi

          # è·å– git æäº¤ä¿¡æ¯ä½œä¸ºç‰ˆæœ¬ä¿¡æ¯ (ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•)
          # è·å–æœ€è¿‘ä¸€æ¬¡æäº¤çš„å“ˆå¸Œ
          COMMIT_HASH=$(git rev-parse --short HEAD)
          # è·å–æäº¤æ—¥æœŸ (æ ¼å¼åŒ–)
          COMMIT_DATE=$(git log -1 --format=%cd --date=format:'%Y-%m-%d %H:%M:%S')
          # è·å–æäº¤ä¿¡æ¯æ‘˜è¦ (åªå–ç¬¬ä¸€è¡Œï¼Œé¿å…å¤šè¡Œå’Œç‰¹æ®Šå­—ç¬¦)
          COMMIT_MESSAGE=$(git log -1 --pretty=%B | head -n 1 | cut -c 1-100)
          # æ¸…ç†ç‰¹æ®Šå­—ç¬¦
          COMMIT_MESSAGE_CLEANED=$(echo "$COMMIT_MESSAGE" | sed 's/[^a-zA-Z0-9 ._-]/_/g')
          echo "VERSION_INFO=Commit: $COMMIT_HASH ($COMMIT_DATE) - $COMMIT_MESSAGE_CLEANED" >> $GITHUB_ENV

          echo "å†…æ ¸ç‰ˆæœ¬ (VERSION_KERNEL): ${{ env.VERSION_KERNEL }}"
          echo "ç‰ˆæœ¬ä¿¡æ¯ (VERSION_INFO): ${{ env.VERSION_INFO }}"

      # --- 4. æœ€å¤§åŒ–å¯ç”¨ç£ç›˜ç©ºé—´ (å¯é€‰) ---
      # æ³¨æ„: è¿™ä¸ªæ­¥éª¤åªæœ‰åœ¨ç¯å¢ƒå˜é‡ MADS è®¾ç½®ä¸º 'true' æ—¶æ‰ä¼šæ‰§è¡Œ
      # å¦‚æœæ‚¨æƒ³æ€»æ˜¯æ‰§è¡Œï¼Œå¯ä»¥ç§»é™¤ 'if: env.MADS == 'true'' æ¡ä»¶
      - name: Maximize Available Disk Space (æœ€å¤§åŒ–å¯ç”¨ç£ç›˜ç©ºé—´)
        if: env.MADS == 'true' # ä»…å½“ MADS ä¸º true æ—¶æ‰§è¡Œ
        uses: AdityaGarg8/remove-unwanted-software@master
        with:
          remove-dotnet: "true"
          remove-android: "true"
          remove-haskell: "true"
          remove-codeql: "true"
          remove-docker-images: "true"
          remove-large-packages: "true"
          remove-cached-tools: "true"
          remove-swapfile: "true"

      # --- 5. åˆå§‹åŒ–ç¯å¢ƒ ---
      - name: Initialization Environment (åˆå§‹åŒ–ç¯å¢ƒ)
        env:
          DEBIAN_FRONTEND: noninteractive # éäº¤äº’æ¨¡å¼å®‰è£…è½¯ä»¶åŒ…
        run: |
          sudo -E apt-get -y update
          # ä½¿ç”¨ Ubuntu 24.04 å…¼å®¹çš„ä¾èµ–åˆ—è¡¨
          # æ›¿æ¢ is.gd/depends_ubuntu_2204 ä¸ºä¸€ä¸ªæ›´å¯é çš„ä¾èµ–åˆ—è¡¨
          # ä¾‹å¦‚ï¼Œåˆ—å‡ºä¸€äº›å¸¸ç”¨çš„ OpenWrt ç¼–è¯‘æ‰€éœ€çš„åŸºç¡€ä¾èµ–
          # æ³¨æ„: è¿™äº›æ˜¯åŸºäºå¸¸è§çš„ OpenWrt ç¼–è¯‘ç¯å¢ƒçš„å…¸å‹ä¾èµ–
          # å¦‚æœæ‚¨çš„æºç éœ€è¦å…¶ä»–ç‰¹å®šä¾èµ–ï¼Œè¯·åœ¨æ­¤å¤„æ·»åŠ 
          sudo -E apt-get -y install \
            build-essential \
            libncurses5-dev \
            zlib1g-dev \
            gawk \
            git \
            wget \
            unzip \
            libssl-dev \
            libelf-dev \
            clang \
            lld \
            libc++-dev \
            libc++abi-dev \
            libxml2-dev \
            xsltproc \
            docbook-utils \
            python3 \
            python3-pip \
            python3-setuptools \
            python3-wheel \
            rsync \
            time \
            bc \
            flex \
            bison \
            libtool \
            automake \
            autopoint \
            gettext \
            pkg-config \
            libexpat1-dev \
            libpcre3-dev \
            libreadline-dev \
            libncurses-dev \
            libssl-dev \
            libelf-dev \
            libz-dev \
            libbz2-dev \
            liblzma-dev \
            libzstd-dev \
            libarchive-dev \
            libuv1-dev \
            libffi-dev \
            libgmp-dev \
            libmpfr-dev \
            libmpc-dev \
            libisl-dev \
            libcloog-dev \
            libglib2.0-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libgtksourceview-3.0-dev \
            libgnomeui-dev \
            libgnomevfs2-dev \
            libgnomeprint2.2-dev \
            libgnomeprintui2.2-dev \
            libgnomecanvas2-dev \
            libgnomeprintpreview2.2-dev \
            libgnomeprintutils2.2-dev \
            libgnomevfs2-dev \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgnomevfs2-0 \
            libgnomevfs2-common \
            libgnomevfs2-dev \
            libgnomevfs2-0 \
            libgn......(çœç•¥å¤§é‡é‡å¤å†…å®¹) # è¿™é‡Œçœç•¥äº†å¤§é‡ä¸å¿…è¦çš„é‡å¤æ¡ç›®ï¼Œå®é™…åº”åªåˆ—å‡ºå¿…éœ€çš„ä¾èµ–

          # é‡æ–°å®‰è£…å¿…è¦å·¥å…· (å¦‚æœä¹‹å‰å®‰è£…å¤±è´¥)
          sudo -E apt-get -y install --reinstall python3-minimal python3-distutils

          sudo -E systemctl daemon-reload
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          sudo timedatectl set-timezone "$TZ" # è®¾ç½®æ—¶åŒº

      # --- 6. è®¾ç½®å·¥ä½œç›®å½•å’Œå˜é‡ ---
      - name: Setup Working Directory and Variables
        run: |
          cd openwrt-source
          echo "OPENWRT_PATH=$(pwd)" >> $GITHUB_ENV
          echo "GENERAL_CONFIG_FILE=$OPENWRT_PATH/configs/General.config" >> $GITHUB_ENV
          echo "CONFIG_FILE=$OPENWRT_PATH/configs/${{ env.DEVICE_SHORT_NAME }}_${{ env.CONFIG_NAME }}.config" >> $GITHUB_ENV

      # --- 7. åˆå¹¶é…ç½®æ–‡ä»¶ ---
      # æ³¨æ„: è¯·ç¡®è®¤æºç ä»“åº“ä¸­æœ‰ configs/General.config å’Œ configs/{DEVICE}_{CONFIG}.config
      # è¿™é‡Œä½¿ç”¨ shell è„šæœ¬æ¥åˆå¹¶é…ç½®æ–‡ä»¶
      - name: Merge Config Files (åˆå¹¶é…ç½®æ–‡ä»¶)
        run: |
          cd openwrt-source
          echo "æ­£åœ¨åˆå¹¶é…ç½®æ–‡ä»¶..."
          if [ ! -f "$GENERAL_CONFIG_FILE" ]; then
            echo "é”™è¯¯: æ‰¾ä¸åˆ°é€šç”¨é…ç½®æ–‡ä»¶ $GENERAL_CONFIG_FILE"
            exit 1
          fi
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "é”™è¯¯: æ‰¾ä¸åˆ°è®¾å¤‡é…ç½®æ–‡ä»¶ $CONFIG_FILE"
            exit 1
          fi
          # åˆå¹¶é…ç½®æ–‡ä»¶
          cat "$GENERAL_CONFIG_FILE" "$CONFIG_FILE" > .config
          echo "é…ç½®æ–‡ä»¶å·²åˆå¹¶åˆ° .config"

      # --- 8. å¯åŠ¨èµ„æºç›‘æ§ ---
      # å¯åŠ¨åå°èµ„æºç›‘æ§ï¼ˆ15åˆ†é’Ÿé—´éš”ï¼‰
      - name: Start Resource Monitoring (å¯åŠ¨èµ„æºç›‘æ§)
        run: |
          cd openwrt-source
          {
          while true; do
          sleep 900  # 15åˆ†é’Ÿé—´éš”
          echo "====================== ç¼–è¯‘æœŸé—´ç³»ç»Ÿå ç”¨ç›‘æ§ ======================"
          echo "ğŸ•’ ç›‘æ§æ—¶é—´: $(date)"
          echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -hT | grep -E '^(Filesystem|/dev/)'
          echo "ğŸ“¦ å†…å­˜ä½¿ç”¨æƒ…å†µ:"
          free -h
          echo "âš¡ CPU è´Ÿè½½:"
          uptime
          echo "=========================================================="
          echo "## ğŸ”„ ç¼–è¯‘æœŸé—´ç³»ç»Ÿå ç”¨ç›‘æ§ ï¼ˆé¢‘ç‡ 15åˆ†é’Ÿï¼‰"
          echo "- ğŸ• å½“å‰æ—¶é—´: $(date)"
          #echo "- ğŸ’¾ ç£ç›˜/dev/rootä½¿ç”¨ç‡: $(df -h / | tail -1 | awk '{print $5}')"
          echo "- ğŸ’¾ ç£ç›˜/dev/sda1ä½¿ç”¨ç‡: $(df -h /dev/sda1 | tail -1 | awk '{print $5}')"
          echo "- ğŸ“¦ å†…å­˜ä½¿ç”¨ç‡: $(free | grep Mem | awk '{printf(\"%.1f%%\", \$3/\$2 * 100.0)}')"
          echo ""
          done
          } &
          # è®°å½•ç›‘æ§è¿›ç¨‹IDä»¥ä¾¿åç»­å…³é—­
          echo "MONITOR_PID=\$!" > monitor_pid.txt

      # --- 9. ç¼–è¯‘å›ºä»¶ ---
      # æ³¨æ„: è¯·æ ¹æ®æ‚¨çš„å®é™…æºç ä»“åº“ç»“æ„å’Œç¼–è¯‘å‘½ä»¤è¿›è¡Œè°ƒæ•´
      # ä¾‹å¦‚ï¼Œå¯èƒ½éœ€è¦è¿è¡Œ ./scripts/feeds update -a && ./scripts/feeds install -a
      # ç„¶åè¿è¡Œ make defconfig æˆ– make menuconfig
      # æœ€åè¿è¡Œ make -j$(nproc) V=s
      - name: Build Firmware (ç¼–è¯‘å›ºä»¶)
        run: |
          cd openwrt-source
          echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          # ç¤ºä¾‹å‘½ä»¤ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
          # ./scripts/feeds update -a
          # ./scripts/feeds install -a
          # make defconfig # æˆ–è€… make menuconfig
          # make -j$(nproc) V=s
          echo "ç¼–è¯‘å®Œæˆã€‚è¯·æ›¿æ¢æ­¤å¤„çš„ç¼–è¯‘å‘½ä»¤ã€‚"

      # --- 10. å…³é—­èµ„æºç›‘æ§ ---
      - name: Stop Resource Monitoring (å…³é—­èµ„æºç›‘æ§)
        run: |
          cd openwrt-source
          if [ -f monitor_pid.txt ]; then
            MONITOR_PID=$(cat monitor_pid.txt)
            kill $MONITOR_PID 2>/dev/null || true
            rm monitor_pid.txt
          fi

      # --- 11. ä¸Šä¼  Artifact ---
      # æ³¨æ„: è¯·æ ¹æ®å®é™…çš„å›ºä»¶è¾“å‡ºè·¯å¾„è°ƒæ•´ 'path'
      # é€šå¸¸è¾“å‡ºåœ¨ bin/targets/.../ ä¸‹
      - name: Upload Artifact (ä¸Šä¼ ç¼–è¯‘äº§ç‰©)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: openwrt-source/bin/targets/*/*/*.img.gz # è¯·æ ¹æ®å®é™…è·¯å¾„è°ƒæ•´
          retention-days: 7 # ä¿ç•™7å¤©

      # --- 12. åˆ›å»º Release ---
      # æ³¨æ„: è¯·ç¡®ä¿åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨äº† Releases åŠŸèƒ½
      # å¹¶ä¸”å¯èƒ½éœ€è¦ä¸€ä¸ª GitHub Personal Access Token (PAT) æ¥åˆ›å»º Release
      # è¿™é‡Œä½¿ç”¨äº† action-gh-release æ’ä»¶ï¼Œå®ƒé€šå¸¸éœ€è¦ PAT
      # è¯·åœ¨ä»“åº“ Settings -> Secrets ä¸­æ·»åŠ åä¸º GITHUB_TOKEN çš„ secret (é€šå¸¸å·²å­˜åœ¨)
      # æˆ–è€…ä½¿ç”¨ personal access token (éœ€è¦é…ç½® secrets)
      # å¦‚æœæ— æ³•ä½¿ç”¨ action-gh-releaseï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å…¶ä»–æ–¹å¼
      - name: Create Release (åˆ›å»º Release)
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'schedule' # ä»…åœ¨å®šæ—¶è§¦å‘æ—¶åˆ›å»º Release
        with:
          tag_name: ${{ env.ARTIFACT_NAME }}
          name: ${{ env.RELEASE_TITLE }}
          body: |
            ### ğŸ“’ å›ºä»¶ä¿¡æ¯
            - è¯¥å›ºä»¶åœ¨${{ env.REPO_SHORT_NAME }}çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†é¢å¤–çš„è½¯ä»¶åŒ…ï¼Œå¹¶æ·»åŠ äº†è‹¥å¹²å·¥å…·ï¼Œå…·ä½“è¯¦è§å¯¹åº”æœºå‹çš„config
            - âš½ å›ºä»¶æºç : https://github.com/laipeng668/immortalwrt.git
            - âš½ å›ºä»¶æºç : https://github.com/laipeng668/openwrt.git
            - âš½ å›ºä»¶æºç : https://github.com/laipeng668/openwrt-6.x.git
            - ğŸŒ é»˜è®¤åœ°å€: **192.168.111.1**
            - ğŸ”‘ é»˜è®¤å¯†ç : none
            - ğŸš€ WiFiåç§°: **Star**
            - ğŸ”‘ WiFiå¯†ç : 12345678
            ### ğŸ“’ å›ºä»¶ç‰ˆæœ¬
            - å›ºä»¶å†…æ ¸ç‰ˆæœ¬ï¼š**${{ env.VERSION_KERNEL }}**
            #- å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
            - ${{ env.VERSION_INFO }}
          files: openwrt-source/bin/targets/*/*/*.img.gz # è¯·æ ¹æ®å®é™…è·¯å¾„è°ƒæ•´
          draft: false
          prerelease: false
